<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL News Deutsch</title>

    <!-- PWA / iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NFL News">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#013369">
    <meta name="description" content="Aktuelle NFL News automatisch ins Deutsche Ã¼bersetzt">

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --blue:   #013369;
            --red:    #D50A0A;
            --dark:   #080d1a;
            --card:   #111827;
            --border: #1e2a3a;
            --text:   #e8eaf0;
            --muted:  #8892a4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* â”€â”€ Header â”€â”€ */
        header {
            background: linear-gradient(135deg, var(--blue) 0%, #021f45 50%, #8B0000 100%);
            padding: env(safe-area-inset-top, 0px) 0 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 30px rgba(0,0,0,0.6);
        }

        .header-inner {
            padding: 16px 20px 14px;
        }

        header h1 {
            font-size: 1.45rem;
            font-weight: 900;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        header p {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 3px;
            letter-spacing: 1px;
        }

        /* â”€â”€ Controls â”€â”€ */
        .controls {
            padding: 18px 16px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .refresh-btn {
            background: linear-gradient(135deg, var(--red), #a00808);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            transition: transform 0.15s, opacity 0.2s;
            box-shadow: 0 4px 20px rgba(213, 10, 10, 0.45);
            width: 100%;
            max-width: 320px;
        }

        .refresh-btn:active { transform: scale(0.96); }
        .refresh-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }

        .status {
            font-size: 0.82rem;
            color: var(--muted);
            text-align: center;
            min-height: 18px;
        }

        /* â”€â”€ News Grid â”€â”€ */
        #news-container {
            padding: 14px 14px 40px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* â”€â”€ Card â”€â”€ */
        .news-card {
            background: var(--card);
            border-radius: 18px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 4px 24px rgba(0,0,0,0.35);
            animation: fadeUp 0.4s ease both;
        }

        .card-img {
            width: 100%;
            height: 195px;
            object-fit: cover;
            display: block;
        }

        .card-body { padding: 16px; }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .badge-num {
            background: var(--red);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 900;
            padding: 2px 9px;
            border-radius: 20px;
            letter-spacing: 1px;
        }

        .badge-label {
            font-size: 0.68rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            line-height: 1.45;
            color: #fff;
            margin-bottom: 10px;
        }

        /* Lead sentence (= translated description) */
        .card-lead {
            font-size: 0.92rem;
            line-height: 1.6;
            color: #c5ccd8;
            font-style: italic;
            margin-bottom: 12px;
            border-left: 3px solid var(--red);
            padding-left: 10px;
        }

        /* Full translated article body */
        .card-story {
            font-size: 0.875rem;
            line-height: 1.75;
            color: var(--muted);
            margin-bottom: 14px;
        }

        /* Divider between lead and story */
        .card-divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .card-date { font-size: 0.72rem; color: #555; }

        .card-link {
            font-size: 0.78rem;
            font-weight: 700;
            color: #4a9eff;
            text-decoration: none;
            padding: 4px 0;
        }

        /* â”€â”€ Loading â”€â”€ */
        .loading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px 20px;
            gap: 16px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid var(--border);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }

        .loading-wrap p { color: var(--muted); font-size: 0.9rem; }

        /* â”€â”€ Error â”€â”€ */
        .error-box {
            background: #1a0f0f;
            border: 1px solid #5a1010;
            border-radius: 14px;
            padding: 24px;
            text-align: center;
            margin: 10px 0;
        }

        .error-box p { color: #ff7070; margin-bottom: 8px; }
        .error-box small { color: var(--muted); font-size: 0.8rem; }

        /* â”€â”€ Empty â”€â”€ */
        .empty-hint {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .empty-hint .football-icon {
            font-size: 4rem;
            display: block;
            margin-bottom: 16px;
            animation: bounce 2s ease infinite;
        }

        .empty-hint h2 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-hint p { font-size: 0.85rem; line-height: 1.6; }

        /* â”€â”€ Progress bar â”€â”€ */
        .progress-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            width: 100%;
            max-width: 320px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--red));
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        /* â”€â”€ Animations â”€â”€ */
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Safe area bottom */
        body::after {
            content: '';
            display: block;
            height: env(safe-area-inset-bottom, 0px);
        }
    </style>
</head>
<body>

<header>
    <div class="header-inner">
        <h1>ğŸˆ NFL News</h1>
        <p>Aktuelle Nachrichten &bull; Auf Deutsch</p>
    </div>
</header>

<div class="controls">
    <button class="refresh-btn" id="refreshBtn" onclick="loadNews()">News laden</button>
    <div class="status" id="status">Tippe auf "News laden" um die Top 10 NFL-News abzurufen</div>
    <div class="progress-bar" id="progressBar" style="display:none">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
</div>

<div id="news-container">
    <div class="empty-hint">
        <span class="football-icon">ğŸˆ</span>
        <h2>Willkommen bei NFL News</h2>
        <p>Lade die aktuellsten 10 NFL-Nachrichten<br>aus den USA â€” automatisch auf Deutsch Ã¼bersetzt.</p>
    </div>
</div>

<script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ESPN_URL   = 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/news?limit=15';
    const TRANS_URL  = 'https://api.mymemory.translated.net/get';
    const CACHE_KEY  = 'nfl_cache_v4';
    const CACHE_TTL  = 30 * 60 * 1000; // 30 min

    let busy = false;

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg;
    }

    function setProgress(pct) {
        const bar  = document.getElementById('progressBar');
        const fill = document.getElementById('progressFill');
        if (pct === null) { bar.style.display = 'none'; return; }
        bar.style.display = 'block';
        fill.style.width  = pct + '%';
    }

    // Strip HTML tags and collapse whitespace
    function stripHtml(html) {
        return (html || '')
            .replace(/<[^>]*>/g, ' ')
            .replace(/&nbsp;/g, ' ')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/\s+/g, ' ')
            .trim();
    }

    async function translate(text, retries = 3) {
        if (!text || !text.trim()) return '';
        const snippet = text.substring(0, 900); // MyMemory ~500 words, ~900 chars safe
        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                const res  = await fetch(`${TRANS_URL}?q=${encodeURIComponent(snippet)}&langpair=en|de`);
                const json = await res.json();
                if (json.responseStatus === 200) {
                    return json.responseData.translatedText || text;
                }
                if (json.responseStatus === 429) await sleep(2000 * (attempt + 1));
            } catch {
                await sleep(500 * (attempt + 1));
            }
        }
        return text; // fallback: original English
    }

    function fmtDate(iso) {
        if (!iso) return '';
        return new Date(iso).toLocaleString('de-DE', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render(articles) {
        const container = document.getElementById('news-container');
        if (!articles || articles.length === 0) {
            container.innerHTML = '<div class="error-box"><p>Keine Artikel gefunden.</p></div>';
            return;
        }

        container.innerHTML = articles.map((a, i) => {
            const img    = a.images?.[0]?.url ?? null;
            const link   = a.links?.web?.href ?? a.links?.mobile?.href ?? null;
            const date   = fmtDate(a.published);
            const byline = a.byline ? escHtml(a.byline) : null;
            const source = a.source ? escHtml(a.source) : null;
            const title  = escHtml(a.titleDE  || a.headline    || 'Kein Titel');
            const lead   = escHtml(a.descDE   || a.description || '');
            const story  = escHtml(a.storyDE  || '');

            return `
            <div class="news-card" style="animation-delay:${i * 60}ms">
                ${img ? `<img class="card-img" src="${img}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
                <div class="card-body">
                    <div class="card-meta">
                        <span class="badge-num">#${i + 1}</span>
                        <span class="badge-label">NFL News</span>
                        ${byline ? `<span class="badge-label" style="margin-left:auto">âœï¸ ${byline}</span>` : (source ? `<span class="badge-label" style="margin-left:auto">ğŸ“° ${source}</span>` : '')}
                    </div>
                    <h2 class="card-title">${title}</h2>
                    ${lead  ? `<p class="card-lead">${lead}</p>` : ''}
                    ${story ? `<div class="card-divider"></div><p class="card-story">${story}</p>` : ''}
                    <div class="card-footer">
                        <span class="card-date">ğŸ“… ${date}</span>
                        ${link ? `<a class="card-link" href="${link}" target="_blank" rel="noopener">VollstÃ¤ndiger Artikel â†’</a>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function escHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    // â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadNews() {
        if (busy) return;
        busy = true;

        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        btn.textContent = 'â³ Wird geladenâ€¦';
        setProgress(5);

        document.getElementById('news-container').innerHTML = `
            <div class="loading-wrap">
                <div class="spinner"></div>
                <p>Lade aktuelle NFL-Newsâ€¦</p>
            </div>`;

        try {
            // 1) Fetch
            setStatus('ğŸ“¡ Verbinde mit ESPNâ€¦');
            const res  = await fetch(ESPN_URL);
            if (!res.ok) throw new Error(`ESPN API Fehler (${res.status})`);
            const data = await res.json();
            const raw  = (data.articles || []).slice(0, 10);
            setProgress(20);

            // 2) Translate
            const articles = [];
            for (let i = 0; i < raw.length; i++) {
                const a = raw[i];
                setStatus(`ğŸ”¤ Ãœbersetze ${i + 1} / ${raw.length}â€¦`);
                setProgress(20 + Math.round((i / raw.length) * 75));

                // Build story text: prefer full article, fallback to description
                const rawStory = stripHtml(a.story || '').substring(0, 900);
                // Translate headline, description lead, and story body
                const [titleDE, descDE, storyDE] = await Promise.all([
                    translate(a.headline    || ''),
                    translate(a.description || ''),
                    rawStory ? translate(rawStory) : Promise.resolve('')
                ]);
                articles.push({ ...a, titleDE, descDE, storyDE });

                if (i < raw.length - 1) await sleep(320); // be nice to MyMemory (3 requests/article)
            }

            setProgress(100);

            // 3) Cache
            localStorage.setItem(CACHE_KEY, JSON.stringify({ data: articles, ts: Date.now() }));

            // 4) Render
            render(articles);
            setStatus(`âœ… ${articles.length} Artikel geladen â€“ ${new Date().toLocaleTimeString('de-DE')}`);

        } catch (err) {
            console.error(err);
            document.getElementById('news-container').innerHTML = `
                <div class="error-box">
                    <p>âŒ Fehler beim Laden der News</p>
                    <small>${err.message}</small>
                </div>`;
            setStatus('Bitte versuche es erneut');
        } finally {
            busy = false;
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Aktualisieren';
            await sleep(600);
            setProgress(null);
        }
    }

    // â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }

    // â”€â”€ Boot: try cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function bootFromCache() {
        try {
            const raw = localStorage.getItem(CACHE_KEY);
            if (!raw) return;
            const { data, ts } = JSON.parse(raw);
            if (!data || !data.length) return;
            render(data);
            const mins = Math.round((Date.now() - ts) / 60000);
            setStatus(`Gespeicherte News â€“ vor ${mins} Minute${mins !== 1 ? 'n' : ''} geladen`);
            document.getElementById('refreshBtn').textContent = 'ğŸ”„ Aktualisieren';
        } catch {}
    })();
</script>
</body>
</html>
